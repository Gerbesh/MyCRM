# Примечания по выполнению для CODEX

Этот документ описывает общие требования для всех задач, выполняемых в проекте при помощи CODEX.

## Сохранение текущего функционала

- Не ломать существующее поведение: любые изменения — только добавления/исправления без удаления фич.
- сключение: явное удаление мёртвого кода/полей — только в рамках соответствующих задач.
- зменения должны быть минимальными и по делу, без побочных «улучшений» вне scope задачи.

## Стандарты кода

- PEP 8: соблюдение стиля и форматирования Python-кода.
- Понятные имена: осмысленные названия переменных, функций, модулей.
- Короткие функции: одна ответственность, простая читаемость, избегать глубокой вложенности.
- Логирование: использовать стандартный модуль `logging` (уровни DEBUG/INFO/WARNING/ERROR), не логировать чувствительные данные.
- Единообразие: следовать текущему стилю проекта; внешние зависимости — только при реальной необходимости.

## Работа с БД

- Alembic не используется; схемы создаются через `db.create_all`.
- При изменении моделей проверяй совместимость со существующими данными и обновляй БД вручную при необходимости.

## Коммиты и версии

- Коммиты атомарные: один логический шаг — один коммит.
- Сообщения осмысленные: что изменено и зачем (кратко и по делу).
- Версионирование: изменения версий фиксировать в `CHANGELOG.md` с кратким описанием (добавлено/исправлено/изменено/удалено).
- При каждом коммите увеличивать версию проекта на 0.0.1 и обновлять файл `VERSION`.

## Тесты

- Для задач приоритета P0/P1 — добавлять/обновлять автотесты, покрывающие критичный функционал изменений.
- Поддерживать актуальность существующих тестов; не ломать стабильные проверки.
- По возможности писать тесты, воспроизводящие найденные дефекты (regression tests).
- Расположение: все тестовые скрипты и файлы — в каталоге `tests/`.
- Покрытие новых функций: все добавленные функции должны иметь 100% покрытие тестами (юнит/интеграционные по необходимости).
- Верификация логики: тесты должны проверять, что интеграция и бизнес‑логика внедрения соответствуют требованиям задачи и “критериям приёмки” (валидируются ожидаемые флаги/заголовки/редиректы/побочные эффекты и т.д.).

## Зависимости и версия Python

- Версия Python в production: 3.10.1. Все изменения должны быть совместимы с Python 3.10.1.
- При добавлении новых зависимостей обязательно обновлять `requirements.txt` (и при необходимости инструкции в README).

## Использование секретов Git

- Для операций с Git и запуска `pre-commit` использовать переменные окружения `GITMAIL` и `GITPASSWORD`, заданные в секретах Codex.
- Перед коммитом настраивать `git` через `GITMAIL` (`user.name`, `user.email`), `GITPASSWORD` использовать при аутентификации.

## Процесс завершения изменений

- Всегда создавать Pull Request в GitHub по завершении задачи (с атомарными коммитами и понятным описанием).
- Приложить ссылку на задачу/тикет, краткое описание изменения и критерии приёмки.
- Убедиться, что тесты из `tests/` проходят локально (`pytest`) и/или в CI.

## Документация

- Обновлять `README.md` и профильные гайды при изменениях функционала/конфигурации/зависимостей.
- Для UI‑тасков не добавлять скриншоты и другие бинарные файлы в репозиторий; pull request не должен содержать бинарников.
- Синхронизировать примеры использования и инструкции по развёртыванию/миграциям.
- При добавлении новых файлов или каталогов, необходимых в продакшене, обязательно обновляйте скрипт `to_depoly.py` (списки `NEEDED_FILES` и `NEEDED_DIRS`).

## Оценка рисков и аудит безопасности

Контекст:

- Репозиторий приватный, доступ имеет только владелец.
- Проект ведётся на личном компьютере, без внешних пользователей и коллег.
- Деплой осуществляется вручную владельцем.

Что НЕ считать критичными угрозами:

- Утечки секретов через публичный git или общий доступ.
- Наличие тестовых/дефолтных админов (если никто кроме владельца не имеет доступ).
- Логирование сессий «для внутреннего пользования» (если логи читает только владелец).

Что остаётся риском (Must-fix):

- FTP-деплой: нужно отказаться, даже если работаешь один (риск MITM).
- Хранение секретов в коде/репо: остаётся проблемой, если ПК будет скомпрометирован.
- Подробные ошибки в проде: критично, если сервер доступен из интернета.
- Отсутствие проверки зависимостей: supply chain угроза, даже для одного разработчика.

Вывод для агентов:

- При аудите не раздувать список «корпоративных угроз» (CI/CD, команда разработчиков, публичные репо и т.д.).
- Фокусироваться только на реально актуальных для личного приватного проекта рисках.

## Общие рекомендации

- Не вносить нерелевантные изменения (рефакторинг — только если необходим для решения задачи и минимален).
- Сначала исправлять корневую причину, а не маскировать симптомы.
- Согласовывать спорные архитектурные решения через ревью/обсуждение до реализации.
- Всегда вносить изменения в CHANGELOG.md
- При деплое не очищать каталоги на сервере: обновляйте файлы поверх, сохраняйте .env и другие рабочие данные.
- Учётные данные для деплоя храните только в .env/.encv (не в git); перед запуском GUI/скриптов задавайте DEPLOY\_\* переменные окружения.

## Согласованность изменений (зависимости и ссылки)

- При изменении сущностей/полей/интерфейсов обязательно обновляй весь код, который на них ссылается: ORM‑модели, SQL/JOIN‑ы, сервисы, вьюхи/blueprints, шаблоны Jinja, фронтенд (JS), API‑контракты, скрипты, экспорт/импорт, миграции и тесты.
- Проводить impact‑анализ: искать все вхождения по ключам (имя поля/таблицы/функции) через `rg -n` и проверять, что ссылки обновлены или задепрекейтены.
- Для БД: сначала вводить новую схему (например, M2M) и переводить код на неё, и только после стабилизации — миграцию удаления legacy‑полей; избегать «боит летом» падений на старых ссылках.
- Если нельзя обновить все места сразу — добавить адаптер/слой совместимости или фича‑флаг, задокументировать период депрекации и план удаления.
- Обязательно обновлять/добавлять тесты на затронутые участки (юнит/интеграция/смоук) и запускать CI; критичные маршруты покрывать smоke‑проверками.
- Синхронизировать документацию (README/гайды/миграции) и примеры после изменений.

## Язык и визуальный стиль

- Русский продукт: весь UI (надписи, статусы, сообщения) и комментарии в коде — на русском языке.
- Доработки должны логично встраиваться в общий визуальный стиль проекта: использовать существующие паттерны классов/отступов/цветов/анимаций. Новые элементы (например, селектор статуса) стилизовать в соответствии с текущими стилями.
