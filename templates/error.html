{% extends "base.html" %} {% block title %}Ошибка {{ error_code }}{% endblock %}
{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card border-danger">
        <div class="card-header bg-danger text-white">
          <h4 class="mb-0">
            <i class="fas fa-exclamation-triangle"></i>
            Ошибка {{ error_code }}
          </h4>
        </div>
        <div class="card-body">
          <div class="text-center mb-4">
            {% if error_code == 404 %}
            <i class="fas fa-search fa-5x text-muted mb-3"></i>
            <h3>Страница не найдена</h3>
            {% elif error_code == 403 %}
            <i class="fas fa-lock fa-5x text-muted mb-3"></i>
            <h3>Доступ запрещен</h3>
            {% elif error_code == 500 %}
            <i class="fas fa-server fa-5x text-muted mb-3"></i>
            <h3>Внутренняя ошибка сервера</h3>
            {% else %}
            <i class="fas fa-exclamation-circle fa-5x text-muted mb-3"></i>
            <h3>Произошла ошибка</h3>
            {% endif %}
          </div>

          <div class="alert alert-danger" role="alert">
            <strong>Сообщение:</strong> {{ error_message }}
          </div>

          {% if error_id %}
          <div class="alert alert-info" role="alert">
            <strong>ID ошибки:</strong> {{ error_id }}
            <br />
            <small class="text-muted"
              >Укажите этот ID при обращении в поддержку.</small
            >
          </div>
          {% endif %} {% if error_trace or request_info %}
          <div class="mt-3">
            <details>
              <summary class="mb-2">
                <strong>Техническая информация</strong> (для диагностики)
              </summary>
              {% if request_info %}
              <div class="mb-3">
                <h6>Запрос</h6>
                <div class="small text-monospace">
                  <div><strong>Метод:</strong> {{ request_info.method }}</div>
                  <div><strong>Путь:</strong> {{ request_info.path }}</div>
                  <div><strong>IP:</strong> {{ request_info.ip }}</div>
                  <div>
                    <strong>User-Agent:</strong> {{ request_info.user_agent }}
                  </div>
                  {% if request_info.request_id %}
                  <div>
                    <strong>Request-ID:</strong> {{ request_info.request_id }}
                  </div>
                  {% endif %} {% if request_info.query %}
                  <div class="mt-2"><strong>Параметры:</strong></div>
                  <pre class="bg-light p-2 border rounded">
{{ request_info.query | tojson(indent=2) }}</pre
                  >
                  {% endif %}
                </div>
              </div>
              {% endif %} {% if error_trace %}
              <div>
                <h6>Трассировка</h6>
                <pre class="bg-light p-2 border rounded small">
{{ error_trace }}</pre
                >
              </div>
              {% endif %}
            </details>
          </div>
          {% endif %}

          <div class="text-center mt-4">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
              <i class="fas fa-home"></i> На дашборд
            </a>
            <button onclick="history.back()" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Назад
            </button>
            <button onclick="location.reload()" class="btn btn-info">
              <i class="fas fa-refresh"></i> Повторить
            </button>
            <button
              onclick="copyErrorDetails()"
              class="btn btn-outline-secondary"
            >
              <i class="fas fa-copy"></i> Скопировать детали
            </button>
            <button onclick="reportError()" class="btn btn-outline-primary">
              <i class="fas fa-bug"></i> Отправить отчёт
            </button>
          </div>
        </div>

        <div class="card-footer text-muted">
          <div class="row">
            <div class="col-md-6">
              <strong>Что можно сделать?</strong>
              <ul class="small mt-2">
                {% if error_code == 404 %}
                <li>Проверьте адрес страницы</li>
                <li>Воспользуйтесь меню навигации</li>
                <li>Вернитесь на дашборд</li>
                {% elif error_code == 403 %}
                <li>Убедитесь, что вы авторизованы</li>
                <li>Попросите доступ у администратора</li>
                <li>Проверьте права доступа</li>
                {% elif error_code == 500 %}
                <li>Обновите страницу</li>
                <li>Подождите пару минут и повторите попытку</li>
                <li>Обратитесь в поддержку, если не помогло</li>
                {% else %}
                <li>Обновите страницу и попробуйте снова</li>
                <li>Вернитесь на предыдущую страницу</li>
                <li>При необходимости — обратитесь в поддержку</li>
                {% endif %}
              </ul>
            </div>
            <div class="col-md-6">
              <strong>Нужна помощь?</strong>
              <ul class="small mt-2">
                <li>Откройте руководство пользователя</li>
                <li>Свяжитесь с техподдержкой</li>
                <li>Сообщите об ошибке</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="application/json" id="error-data">
  {
    "error_code": {{ error_code|tojson }},
    "error_message": {{ error_message|tojson }},
    "error_id": {{ error_id|tojson }},
    "request": {{ (request_info or {}) | tojson }},
    "trace": {{ (error_trace or '') | tojson }}
  }
</script>

<!-- inline error handlers moved to static/js/error.js -->
<script>
  // Auto-hide flash messages after 5 seconds
  setTimeout(function() {
      var alerts = document.querySelectorAll('.alert:not(.alert-danger)');
      alerts.forEach(function(alert) {
          alert.style.transition = 'opacity 0.5s';
          alert.style.opacity = '0';
          setTimeout(function() {
              alert.remove();
          }, 500);
      });
  }, 5000);

  // Скопировать детали ошибки в буфер обмена
  function copyErrorDetails() {
      var data = {
          error_code: '{{ error_code }}',
          error_message: '{{ error_message }}',
          error_id: '{{ error_id }}',
          request: {{ (request_info or {}) | tojson }},
          trace: `{{ (error_trace or '') | replace('`','\`') }}`.slice(0, 8000)
      };
      var text = JSON.stringify(data, null, 2);
      navigator.clipboard.writeText(text).then(function(){
          alert('Детали ошибки скопированы');
      }).catch(function(){
          console.log('Error details:', text);
          alert('Не удалось скопировать. Детали показаны в консоли.');
      });
  }

  // Отправить отчёт об ошибке как audit-событие
  function reportError() {
      var payload = {
          name: 'error_report',
          data: {
              error_code: '{{ error_code }}',
              error_message: '{{ error_message }}',
              error_id: '{{ error_id }}',
              request: {{ (request_info or {}) | tojson }},
              trace: `{{ (error_trace or '') | replace('`','\`') }}`.slice(0, 8000)
          },
          csrf_token: (window.CSRF_TOKEN || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'))
      };
      fetch('/api/v1/audit/event', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
          credentials: 'same-origin',
          body: JSON.stringify(payload)
      }).then(function(){ alert('Отчёт об ошибке отправлен'); }).catch(function(){ alert('Не удалось отправить отчёт'); });
  }
</script>
<script src="{{ url_for('static', filename='js/error.js') }}" defer></script>
{% endblock %}
