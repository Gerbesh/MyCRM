{% extends "base.html" %} {% block title %}–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ - –ö—Ä–µ–ø–ª–µ–Ω–∏—è{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='wizard-animations.css') }}"
/>
<!-- Enhanced mobile viewport and PWA settings -->
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="–ö—Ä–µ–ø–ª–µ–Ω–∏—è CRM" />
<meta name="theme-color" content="{{ THEME_COLOR }}" />
<meta name="msapplication-TileColor" content="{{ THEME_COLOR }}" />
<meta name="msapplication-tap-highlight" content="no" />
<!-- Touch icons for mobile -->
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="{{ url_for('static', filename='apple-touch-icon.png') }}"
  onerror="this.remove()"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="{{ url_for('static', filename='favicon-32x32.png') }}"
  onerror="this.remove()"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="{{ url_for('static', filename='favicon-16x16.png') }}"
  onerror="this.remove()"
/>
<!-- Fallback favicon -->
<link
  rel="icon"
  href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüìã%3C/text%3E%3C/svg%3E"
  type="image/svg+xml"
/>
<!-- Preconnect for performance -->
<link rel="preconnect" href="{{ url_for('static', filename='') }}" />
<link rel="dns-prefetch" href="{{ url_for('static', filename='') }}" />
{% endblock %} {% block content %}
<div class="content-wrapper fade-in">
  <div
    id="wizard-loading-overlay"
    class="wizard-loading-overlay"
    role="status"
    aria-live="polite"
    aria-label="–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Å—Ç–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏"
    style="display: none"
  >
    <div class="wizard-loading-card" role="presentation">
      <div class="wizard-loading-icon" aria-hidden="true">
        <i class="bi bi-cloud-download"></i>
      </div>
      <h2 class="wizard-loading-title">–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—Ç–µ—Ä</h2>
      <p id="wizard-loading-detail" class="wizard-loading-text">
        –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü —Å –¥–∞–Ω–Ω—ã–º–∏‚Ä¶
      </p>
      <div class="progress wizard-loading-progress" role="presentation">
        <div
          class="progress-bar"
          id="wizard-loading-bar"
          role="progressbar"
          aria-valuenow="0"
          aria-valuemin="0"
          aria-valuemax="100"
          style="width: 0%"
        ></div>
      </div>
      <p id="wizard-loading-label" class="wizard-loading-subtext">0%</p>
    </div>
  </div>

  <!-- Mobile-Optimized Page Header with enhanced accessibility -->
  <div
    class="d-flex justify-content-between align-items-start mb-3"
    role="banner"
  >
    <div class="flex-grow-1">
      <h1
        class="gradient-text h3 mb-1 d-flex align-items-center"
        id="page-title"
      >
        <i class="bi bi-plus-circle-dotted me-2" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏</span>
        <span class="d-sm-none">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</span>
      </h1>
      <p class="text-muted mb-0 small d-none d-sm-block">
        –ü–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
      </p>
    </div>
    <a
      href="{{ url_for('main.dashboard') }}"
      class="btn btn-outline-primary btn-sm d-flex align-items-center"
      role="button"
      aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–∞—à–±–æ—Ä–¥—É"
    >
      <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>
      <span class="d-none d-sm-inline">–ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</span>
      <span class="d-sm-none">–ù–∞–∑–∞–¥</span>
    </a>
  </div>

  {% if current_user.role == 'demo' %}
  <div class="alert alert-warning" role="status">
    <i class="bi bi-eye me-2"></i>
    –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –ú–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –≤—Å–µ —à–∞–≥–∏ –º–∞—Å—Ç–µ—Ä–∞, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∞
    –∑–∞—è–≤–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞.
  </div>
  {% endif %}

  <!-- Enhanced Mobile-Friendly Progress Indicator -->
  <div
    class="wizard-progress mb-3"
    id="wizard-progress"
    style="display: none"
    role="progressbar"
    aria-valuenow="25"
    aria-valuemin="0"
    aria-valuemax="100"
    aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏"
  >
    <div class="progress" style="height: 6px" role="presentation">
      <div
        class="progress-bar bg-primary"
        role="progressbar"
        style="width: 25%"
        aria-valuenow="25"
        aria-valuemin="0"
        aria-valuemax="100"
      ></div>
    </div>
    <div
      class="d-flex justify-content-between mt-2 d-none d-sm-flex"
      role="navigation"
      aria-label="–®–∞–≥–∏ –º–∞—Å—Ç–µ—Ä–∞"
    >
      <small class="text-muted">–û–±—ä–µ–∫—Ç</small>
      <small class="text-muted">–ü–æ–¥—Ä—è–¥—á–∏–∫–∏</small>
      <small class="text-muted">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏</small>
      <small class="text-muted">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</small>
    </div>
    <!-- Enhanced step indicator with navigation -->
    <div
      class="d-flex justify-content-center align-items-center mt-2"
      role="status"
      aria-live="polite"
    >
      <button
        class="btn btn-sm btn-outline-secondary me-2"
        id="prev-step-btn"
        style="display: none"
        aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥"
        onclick="window.requestWizard.prevStep()"
      >
        <i class="bi bi-chevron-left me-1"></i>–ù–∞–∑–∞–¥
      </button>
      <small class="text-muted mx-2 d-sm-none"
        >–®–∞–≥ <span id="current-step" class="fw-bold">1</span> –∏–∑ 4</small
      >
      <button
        class="btn btn-sm btn-link p-1 ms-2 d-sm-none"
        id="next-step-btn"
        style="display: none"
        aria-label="–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥"
      >
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
    <!-- Mobile swipe hint -->
    <div class="d-sm-none mt-1 text-center">
      <small class="text-muted" style="font-size: 0.75rem">
        <i class="bi bi-hand-index" style="font-size: 0.8rem"></i> –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –¥–ª—è
        –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      </small>
    </div>
  </div>

  <!-- Wizard Container -->
  <div class="wizard-container slide-up" id="request-wizard">
    <!-- Steps will be dynamically generated here -->
  </div>

  <!-- Hidden form for data submission -->
  <form
    id="create-request-form"
    method="POST"
    enctype="multipart/form-data"
    style="display: none"
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="object_id" id="final_object_id" />
    <input type="hidden" name="contractor_ids_json" id="final_contractor_ids" />
    <input type="hidden" name="manufacturers_json" id="final_manufacturers" />
    <textarea
      name="request_comment"
      id="final_comment"
      style="display: none"
    ></textarea>
    <input
      type="file"
      name="files[]"
      id="final_files"
      multiple
      style="display: none"
    />
  </form>

  <!-- Enhanced Mobile-Optimized Drag & Drop Overlay -->
  <div
    class="drag-drop-overlay"
    id="drag-drop-overlay"
    role="dialog"
    aria-modal="true"
    tabindex="-1"
    aria-labelledby="drop-title"
    aria-describedby="drop-desc"
  >
    <div class="drag-drop-message">
      <div class="drag-drop-icon" role="presentation">
        <i
          class="bi bi-cloud-upload"
          style="font-size: 3rem"
          aria-hidden="true"
        ></i>
      </div>
      <p class="drag-drop-text" id="drop-title">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</p>
      <small class="text-muted d-none d-sm-block" id="drop-desc"
        >–û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</small
      >
      <small class="text-muted d-sm-none" id="drop-desc-mobile"
        >–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</small
      >
      <!-- Mobile file selection button -->
      <button
        class="btn btn-primary mt-3 d-sm-none"
        id="mobile-file-select"
        aria-label="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã"
      >
        <i class="bi bi-folder2-open me-2"></i>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
      </button>
    </div>
  </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="manufacturers-data">
  {{ manufacturers | tojson | safe }}
</script>
<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥ –º–æ–¥–∞–ª–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è -->
<div id="restore-draft-modal-root"></div>
{% endblock %} {% block scripts %}
<!-- Mobile performance optimizations -->
<script>
  // Enhanced global URLs and data for JavaScript with mobile optimizations
  window.CRM_URLS = {
    GET_ALL_OBJECTS: '{{ url_for("api_v1.get_all_objects") }}',
    GET_ALL_CONTRACTORS: '{{ url_for("api_v1.get_all_contractors") }}',
    ADD_OBJECT: '{{ url_for("object.add_object") }}',
    ADD_CONTRACTOR: '{{ url_for("contractor.add_contractor") }}',
    CREATE_REQUEST: '{{ url_for("request_crud.create_request") }}',
    DRAFT: '{{ url_for("request_crud.draft_session") }}',
  };

  // CSRF token
  window.CSRF_TOKEN = '{{ csrf_token() }}';

  // Mobile device detection
  window.IS_MOBILE =
    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
      navigator.userAgent
    ) ||
    window.innerWidth <= 768 ||
    'ontouchstart' in window;

  // Initialize wizard progress with mobile enhancements
  document.addEventListener('DOMContentLoaded', function () {
    const progressElement = document.getElementById('wizard-progress');
    if (progressElement) {
      progressElement.style.display = 'block';
    }

    // Initialize mobile-specific features
    if (window.IS_MOBILE) {
      // Add mobile CSS class
      document.body.classList.add('mobile-device');

      // Optimize viewport for mobile
      const viewport = document.querySelector('meta[name="viewport"]');
      if (viewport) {
        viewport.setAttribute(
          'content',
          'width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover'
        );
      }

      // Prevent context menu on long press for better UX
      document.addEventListener('contextmenu', function (e) {
        if (e.target.closest('.wizard-container')) {
          e.preventDefault();
        }
      });

      // Handle orientation changes
      window.addEventListener('orientationchange', function () {
        setTimeout(function () {
          // Force viewport height recalculation
          document.documentElement.style.setProperty(
            '--vh',
            window.innerHeight * 0.01 + 'px'
          );
        }, 500);
      });

      // Set initial viewport height for mobile browsers
      document.documentElement.style.setProperty(
        '--vh',
        window.innerHeight * 0.01 + 'px'
      );
    }

    // Performance optimization: Preload critical resources
    if ('requestIdleCallback' in window) {
      requestIdleCallback(function () {
        // Preload next step resources when idle
        if (window.CRM_URLS && window.CRM_URLS.GET_ALL_OBJECTS) {
          const link = document.createElement('link');
          link.rel = 'prefetch';
          link.href = window.CRM_URLS.GET_ALL_OBJECTS;
          document.head.appendChild(link);
        }
      });
    }
  });

  // PWA install prompt handling
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Show install button if desired
  });
</script>
{% if copy_data %}
<script>
  window.COPY_REQUEST_DATA = {{ copy_data|tojson|safe }};
</script>
{% endif %}
<script src="{{ url_for('static', filename='create_request.js') }}"></script>
{% endblock %}
